<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ç®¡ç† - LINEæ‰“åˆ»</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .clock {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .date {
            font-size: 18px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .user-code {
            font-size: 16px;
            opacity: 0.9;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .action-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn .icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .action-btn .label {
            font-size: 14px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .login-container {
            text-align: center;
            padding: 40px 20px;
        }

        .login-container .logo {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .setup-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .records-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-working {
            display: inline-block;
            padding: 4px 8px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-off {
            display: inline-block;
            padding: 4px 8px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 4px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div id="loadingScreen" class="card loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen" class="card login-container" style="display: none;">
            <div class="logo">ğŸ±</div>
            <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #666; margin: 20px 0;">LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
            <button class="btn btn-primary" onclick="liffLogin()">
                LINEã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <!-- åˆæœŸè¨­å®šç”»é¢ -->
        <div id="setupScreen" class="card" style="display: none;">
            <div class="header">
                <h1>åˆæœŸè¨­å®š</h1>
                <p style="color: #666;">å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
            </div>
            <form id="setupForm" class="setup-form">
                <div class="form-group">
                    <label>å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰</label>
                    <input type="text" 
                           id="setupEmployeeCode" 
                           class="form-control" 
                           placeholder="ä¾‹: EMP001"
                           required>
                </div>
                <button type="submit" class="btn btn-primary">
                    è¨­å®šã‚’ä¿å­˜
                </button>
            </form>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" style="display: none;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± -->
            <div class="card">
                <div class="header">
                    <div class="logo">ğŸ±</div>
                    <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                </div>

                <div class="clock" id="clock">00:00:00</div>
                <div class="date" id="date">2024å¹´1æœˆ1æ—¥ æœˆæ›œæ—¥</div>

                <div class="user-info">
                    <div class="user-name" id="userName">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div class="user-code" id="userCode">-</div>
                </div>
            </div>

            <!-- æ‰“åˆ»ã‚¨ãƒªã‚¢ -->
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center;">æ‰“åˆ»</h2>
                
                <div id="messageArea"></div>

                <div class="action-buttons">
                    <div class="action-btn" onclick="selectAction('in')">
                        <div class="icon">ğŸ¢</div>
                        <div class="label">å‡ºå‹¤</div>
                    </div>
                    <div class="action-btn" onclick="selectAction('out')">
                        <div class="icon">ğŸ </div>
                        <div class="label">é€€å‹¤</div>
                    </div>
                </div>

                <button id="punchBtn" class="btn btn-success" onclick="punch()" disabled>
                    æ‰“åˆ»ã™ã‚‹
                </button>

                <button class="btn btn-info" onclick="scanQR()">
                    ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹
                </button>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div style="text-align: center; margin-top: 20px;">
                    <div id="currentStatus" class="status-off">
                        æœªå‡ºå‹¤
                    </div>
                </div>
            </div>

            <!-- æœ¬æ—¥ã®è¨˜éŒ² -->
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“‹ æœ¬æ—¥ã®æ‰“åˆ»è¨˜éŒ²</h2>
                <div class="records-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ™‚åˆ»</th>
                                <th>ç¨®é¡</th>
                                <th>æ–¹æ³•</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">
                                    æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è¨­å®š -->
            <div class="card">
                <button class="btn btn-primary" onclick="showSettings()">
                    âš™ï¸ è¨­å®šå¤‰æ›´
                </button>
                <button class="btn" style="background: #dc3545; color: white;" onclick="liffLogout()">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // è¨­å®š
        // ========================================
        const LIFF_ID = '2008444059-JmVGoO57'; // æ­£ã—ã„LIFF ID
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyqpql1mobPxD_2qrnfSb7CobAKwjgjC-dD7ELLGNSBrOtw1LDpNJv7Ia3LekNtuv98/exec';
        
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let liffProfile = null;
        let employeeCode = null;
        let selectedAction = null;
        let records = [];
        let employeeData = null;

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        window.onload = function() {
            initializeLiff();
            updateClock();
            setInterval(updateClock, 1000);
        };

        // LIFFåˆæœŸåŒ–
        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
                    const profile = await liff.getProfile();
                    liffProfile = profile;
                    
                    // å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ç¢ºèª
                    employeeCode = localStorage.getItem('employeeCode_' + profile.userId);
                    
                    if (employeeCode) {
                        // Google Sheetsã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
                        await loadDataFromSheets();
                        showMainScreen();
                    } else {
                        showSetupScreen();
                    }
                } else {
                    showLoginScreen();
                }
            } catch (error) {
                console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                showLoginScreen();
            }
        }

        // ========================================
        // Google Sheetsé€£æº
        // ========================================
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆGoogle Sheets â†’ ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
        async function loadDataFromSheets() {
            try {
                // ä»Šæ—¥ã®å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${GAS_API_URL}?action=getAttendance&employeeCode=${employeeCode}&startDate=${today}&endDate=${today}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.records) {
                        records = data.records;
                        updateRecordsTable();
                        updateStatus();
                    }
                }
            } catch (error) {
                console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆæ­£å¸¸ï¼‰:', error);
                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒã€ãƒ‡ãƒ¼ã‚¿ã¯é€ä¿¡ã•ã‚Œã‚‹
            }
        }

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« â†’ Google Sheetsï¼‰
        async function sendToSheets(action, data) {
            try {
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // CORSå›é¿
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });
                console.log('Google Sheetsã«é€ä¿¡ã—ã¾ã—ãŸ');
                return true;
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ========================================
        // ç”»é¢åˆ¶å¾¡
        // ========================================
        
        function hideAllScreens() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'none';
        }

        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('loginScreen').style.display = 'block';
        }

        function showSetupScreen() {
            hideAllScreens();
            document.getElementById('setupScreen').style.display = 'block';
        }

        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').style.display = 'block';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            if (liffProfile) {
                document.getElementById('userName').textContent = liffProfile.displayName;
                document.getElementById('userCode').textContent = 'å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰: ' + employeeCode;
            }
            
            // è¨˜éŒ²æ›´æ–°
            updateRecordsTable();
            updateStatus();
        }

        // ========================================
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        // ========================================
        
        // LINEãƒ­ã‚°ã‚¤ãƒ³
        function liffLogin() {
            liff.login();
        }

        // LINEãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function liffLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                liff.logout();
                window.location.reload();
            }
        }

        // åˆæœŸè¨­å®šä¿å­˜
        document.getElementById('setupForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const code = document.getElementById('setupEmployeeCode').value;
            
            if (code) {
                employeeCode = code;
                localStorage.setItem('employeeCode_' + liffProfile.userId, code);
                
                // Google Sheetsã«å¾“æ¥­å“¡æƒ…å ±ã‚’ç™»éŒ²
                await sendToSheets('addEmployee', {
                    code: employeeCode,
                    name: liffProfile.displayName,
                    lineId: liffProfile.userId
                });
                
                showMainScreen();
            }
        });

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ
        function selectAction(type) {
            selectedAction = type;
            
            // UIæ›´æ–°
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (type === 'in') {
                document.querySelectorAll('.action-btn')[0].classList.add('active');
                document.getElementById('punchBtn').textContent = 'å‡ºå‹¤ã‚’è¨˜éŒ²';
            } else {
                document.querySelectorAll('.action-btn')[1].classList.add('active');
                document.getElementById('punchBtn').textContent = 'é€€å‹¤ã‚’è¨˜éŒ²';
            }
            
            document.getElementById('punchBtn').disabled = false;
        }

        // æ‰“åˆ»
        async function punch(isFromQR = false) {
            if (!selectedAction) {
                showMessage('æ‰“åˆ»ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // è¨˜éŒ²ä½œæˆ
            const record = {
                employeeCode: employeeCode,
                employeeName: liffProfile.displayName,
                lineUserId: liffProfile.userId,
                type: selectedAction,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ja-JP'),
                method: isFromQR ? 'QRã‚³ãƒ¼ãƒ‰' : 'æ‰‹å‹•',
                timestamp: new Date().toISOString()
            };
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            records.push(record);
            
            // Google Sheetsã«é€ä¿¡
            const success = await sendToSheets('punch', record);
            
            if (success || true) { // no-corsã§ã‚‚æˆåŠŸã¨ã¿ãªã™
                const actionText = selectedAction === 'in' ? 'å‡ºå‹¤' : 'é€€å‹¤';
                showMessage(`${actionText}ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`, 'success');
                
                updateRecordsTable();
                updateStatus();
                
                // ãƒªã‚»ãƒƒãƒˆ
                selectedAction = null;
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('punchBtn').disabled = true;
                document.getElementById('punchBtn').textContent = 'æ‰“åˆ»ã™ã‚‹';
            }
        }

        // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
        async function scanQR() {
            try {
                if (!liff.scanCodeV2) {
                    showMessage('QRã‚¹ã‚­ãƒ£ãƒ³æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                    return;
                }
                
                const result = await liff.scanCodeV2();
                
                // QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è§£æ
                try {
                    const qrData = JSON.parse(result.value);
                    
                    if (qrData.action === 'attendance' && qrData.type) {
                        selectedAction = qrData.type;
                        await punch(true);
                    }
                } catch (error) {
                    showMessage('QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('QRã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ========================================
        // UIæ›´æ–°
        // ========================================
        
        // æ™‚è¨ˆæ›´æ–°
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('ja-JP');
            document.getElementById('date').textContent = now.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        }

        // è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsTableBody');
            const todayRecords = records.filter(r => {
                const today = new Date().toISOString().split('T')[0];
                return r.date === today;
            });
            
            if (todayRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
            } else {
                tbody.innerHTML = todayRecords.map(r => `
                    <tr>
                        <td>${r.time}</td>
                        <td>${r.type === 'in' ? 'å‡ºå‹¤' : 'é€€å‹¤'}</td>
                        <td>${r.method}</td>
                    </tr>
                `).join('');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus() {
            const statusElement = document.getElementById('currentStatus');
            const todayRecords = records.filter(r => {
                const today = new Date().toISOString().split('T')[0];
                return r.date === today;
            });
            
            const hasClockIn = todayRecords.some(r => r.type === 'in');
            const hasClockOut = todayRecords.some(r => r.type === 'out');
            
            if (hasClockIn && !hasClockOut) {
                statusElement.className = 'status-working';
                statusElement.textContent = 'å‹¤å‹™ä¸­';
            } else if (hasClockIn && hasClockOut) {
                statusElement.className = 'status-off';
                statusElement.textContent = 'é€€å‹¤æ¸ˆã¿';
            } else {
                statusElement.className = 'status-off';
                statusElement.textContent = 'æœªå‡ºå‹¤';
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // è¨­å®šç”»é¢
        function showSettings() {
            const newCode = prompt('æ–°ã—ã„å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', employeeCode);
            if (newCode) {
                employeeCode = newCode;
                localStorage.setItem('employeeCode_' + liffProfile.userId, newCode);
                document.getElementById('userCode').textContent = 'å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰: ' + employeeCode;
                showMessage('å¾“æ¥­å“¡ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            }
        }
    </script>
</body>
</html>